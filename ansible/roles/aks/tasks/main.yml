---
- name: Cargar las credenciales de Azure desde el archivo cifrado
  include_vars:
    file: "/root/ansibleproxmox/ansible/azure_credentials.yml"

- name: Initialize Terraform
  command: "terraform init"
  args:
    chdir: "/root/ansibleproxmox/terraform"
  register: result1

- name: Verificar que las variables de Azure se cargaron correctamente
  fail:
    msg: "La variable azure_credentials no está cargada correctamente."
  when: azure_credentials is not defined

- name: Verificar variables cargadas desde el Vault
  debug:
    msg:
      - "Client ID: {{ azure_credentials.client_id }}"
      - "Client Secret: {{ azure_credentials.client_secret }}"
      - "Tenant ID: {{ azure_credentials.tenant_id }}"
      - "Subscription ID: {{ azure_credentials.subscription_id }}"

- name: Autenticarse en Azure usando Service Principal
  shell: |
    echo "Autenticándose en Azure..."
    az login --service-principal -u {{ azure_credentials.client_id }} -p {{ azure_credentials.client_secret }} --tenant {{ azure_credentials.tenant_id }}
  environment:
    AZURE_CLIENT_ID: "{{ azure_credentials.client_id }}"
    AZURE_CLIENT_SECRET: "{{ azure_credentials.client_secret }}"
    AZURE_SUBSCRIPTION_ID: "{{ azure_credentials.subscription_id }}"
    AZURE_TENANT_ID: "{{ azure_credentials.tenant_id }}"

- name: Show output of 1st step in Terraform
  debug:
    msg: "Status of terraform init output: {{ result1.stdout_lines }}"

- name: Apply Terraform configuration
  command: "terraform apply -auto-approve"
  args:
    chdir: "/root/ansibleproxmox/terraform"
  register: result2
  environment:
    ARM_CLIENT_ID: "{{ azure_credentials.client_id }}"
    ARM_CLIENT_SECRET: "{{ azure_credentials.client_secret }}"
    ARM_SUBSCRIPTION_ID: "{{ azure_credentials.subscription_id }}"
    ARM_TENANT_ID: "{{ azure_credentials.tenant_id }}"
    TF_LOG: "INFO"
    TF_IN_AUTOMATION: "1"
    TF_CLI_ARGS: "-no-color"
  ignore_errors: true
